<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Отключения в Краснодаре — Тепловая карта</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Отключаем кэширование HTML -->
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <!-- Статическое подключение стилей -->
  <link
	rel="stylesheet"
	href="/power/style.css?ts=20250701"
	type="text/css"
  />

  <!-- Яндекс.Карты API + Heatmap -->
  <script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU" type="text/javascript"></script>
  <script src="https://yastatic.net/s3/mapsapi-jslibs/heatmap/0.0.1/heatmap.min.js" type="text/javascript"></script>
  <!-- Font Awesome -->
  <link
	rel="stylesheet"
	href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
  />

  <!-- Небольшие правки для мобильных -->
  <style>
	@media (max-width: 768px) {
	  .header-row {
		flex-direction: column;
		align-items: flex-start;
	  }
	  .info-btn {
		margin: 10px 0 0 0;
	  }
	  .search-bar {
		margin: 0 20px 15px;
	  }
	  .main-content {
		flex-direction: column;
	  }
	  #map {
		height: 300px;   /* уменьшили высоту карты на мобиле */
		margin: 0 20px 20px;
	  }
	  #sidebar {
		margin: 0 20px 20px;
	  }
	}
  </style>
</head>
<body>
  <div class="header-row" style="display:flex; align-items:center; gap:30px; margin:20px;">
	<h1 style="margin:0; font-size:1.5rem;">НЕ электросети</h1>
	<a href="https://sashko.site/power/info.html" class="info-btn" aria-label="Что это такое?">
	  Что это такое?
	</a>
  </div>

  <div id="disclaimer" role="alert" aria-live="polite">
	<strong>Внимание:</strong> Достоверность неофициальная, данные собраны путём парсинга документов,
	возможны ошибки в адресах и времени отключений.<br><br>
	Это лишь демонстрация — всегда сверяйте с официальным сайтом:
	<a href="https://www.kubels.ru/" target="_blank" rel="noopener">kubels.ru</a>.
  </div>

  <div class="search-bar" style="display:flex; gap:8px; margin:0 20px 15px;">
	<input
	  type="text"
	  id="address-input"
	  placeholder="Например, Уральская, 98"
	  autocomplete="off"
	  aria-label="Введите адрес для поиска"
	  style="flex:1; padding:8px 12px; font-size:1rem; border:1px solid #ccc; border-radius:6px;"
	/>
	<button id="search-btn" aria-label="Поиск" style="padding:8px 16px; font-size:1rem; background:#0055cc; color:#fff; border:none; border-radius:6px; cursor:pointer;">
	  <i class="fa fa-search"></i> Поиск
	</button>
  </div>
  <div class="main-content" style="display:flex; height:calc(100vh - 200px); overflow:hidden;">
	
	<div id="map" style="flex:1; height:600px; margin:0 10px 10px 20px; border-radius:8px; box-shadow:0 0 8px rgba(0,0,0,0.1);"></div>
	<div id="sidebar" style="flex:1; display:flex; flex-direction:column; overflow:hidden; margin:0 20px 10px 10px;">
	  <div id="loading-status" aria-live="polite" aria-busy="true" style="display:flex; align-items:center; gap:10px; padding:12px; background:#fff; border-radius:8px; box-shadow:inset 0 0 4px rgba(0,0,0,0.05); margin-bottom:10px; flex:0 0 auto;">
		<div class="loader" style="border:4px solid #eee; border-top:4px solid #007aff; border-radius:50%; width:20px; height:20px; animation:spin 1s linear infinite;"></div>
		Подождите, данные загружаются...
	  </div>
	  <div id="result" aria-live="polite" aria-atomic="true" style="flex:1; overflow-y:auto; padding:12px; background:#fff; border-radius:8px; box-shadow:inset 0 0 6px rgba(0,0,0,0.05);"></div>
	</div>
  </div>

  <script>
	// Обновляем карту при повороте/изменении размеров экрана
	window.addEventListener('resize', () => {
	  if (map && map.container) {
		map.container.fitToViewport();
	  }
	});
  </script>

  <script>
	const csvUrl = 'https://raw.githubusercontent.com/sashkokrd/sashkokrd.github.io/main/output_all_in_krasnodar.csv';
	let map, heatmap, outages = [];

	ymaps.ready(init);
	function init() {
	  map = new ymaps.Map("map", {
		center: [45.035, 38.975],
		zoom: 12,
		controls: ['zoomControl','fullscreenControl']
	  });
	  loadData();
	}

	async function loadData() {
	  try {
		const res = await fetch(csvUrl);
		if (!res.ok) throw new Error('Ошибка загрузки данных');
		const text = await res.text();
		outages = parseCsv(text);
		document.getElementById('loading-status').style.display = 'none';
		document.getElementById('result').innerHTML =
		  `✅ Загружено ${outages.length} адресов отключений.`;
		addHeatmap(outages);
	  } catch (err) {
		document.getElementById('loading-status').style.display = 'none';
		document.getElementById('result').textContent = `Ошибка: ${err.message}`;
		console.error(err);
	  }
	}

	function addHeatmap(data) {
	  const points = data.map(o => [o.lat, o.lon, 1]);
	  if (heatmap) { heatmap.destroy(); heatmap = null; }
	  ymaps.modules.require(['Heatmap'], Heatmap => {
		heatmap = new Heatmap(points, {
		  radius: 5,
		  opacity: 0.6,
		  gradient: {
		    0.0: 'rgba(255, 0, 0, 1)',
		    1.0: 'rgba(255, 0, 0, 1)'
			}
		  });
		heatmap.setMap(map);
	  });
	}

	function parseCsv(text) {
	  const lines = text.trim().split('\n');
	  const header = lines[0].split(';').map(h => h.trim());
	  return lines.slice(1).reduce((arr, line) => {
		const cols = line.split(';').map(c => c.trim());
		if (cols.length < header.length) return arr;
		const row = Object.fromEntries(header.map((h,i) => [h, cols[i]]));
		const lat = parseFloat((row.latitude_checked || row.latitude || '').replace(',','.'));
		const lon = parseFloat((row.longitude_checked || row.longitude || '').replace(',','.'));
		if (!row.address || isNaN(lat) || isNaN(lon)) return arr;
		arr.push({
		  originalAddress: row.address,
		  normalizedAddress: row.normalized_address_checked || row.normalized_address || '',
		  date: row.date,
		  lat, lon
		});
		return arr;
	  }, []);
	}

	// Поиск
	const btn = document.getElementById('search-btn');
	const input = document.getElementById('address-input');
	let timeoutId;
	btn.addEventListener('click', doSearch);
	input.addEventListener('input', () => {
	  clearTimeout(timeoutId);
	  timeoutId = setTimeout(doSearch, 400);
	});

	function doSearch() {
	  const q = input.value.trim().toLowerCase();
	  const box = document.getElementById('result');
	  if (!q) {
		box.textContent = 'Введите адрес для проверки.';
		return;
	  }
	  const found = outages.filter(o =>
		o.originalAddress.toLowerCase().includes(q)
	  );
	  if (!found.length) {
		box.textContent = 'Отключений не найдено.';
		addHeatmap([]);
		map.setCenter([45.035, 38.975], 12);
		return;
	  }

	  let html = `<p>Найдено ${found.length} совпадений:</p>`;
	  found.forEach(o => {
		const addr = o.normalizedAddress || o.originalAddress;
		const isGardenCommunity = /СНТ/.test(addr) || /ДНТ/.test(addr);
		const nums = addr.match(/\b\d+\/?\d*\b/g) || [];
		const hasHouseNumber = nums.some(n => n.includes('/') || n.length <= 4);
		let note = '';
		if (isGardenCommunity) {
		  note = `<span class="address-note">
					Вероятно, эта улица находится в посёлке Водники, 
					автоматический поиск геолокации сработал неверно.
				  </span>`;
		} else if (!hasHouseNumber) {
		  note = `<span class="address-note">
					Адрес не содержит номера дома и, возможно, ошибочен.
				  </span>`;
		}
		html += `
		  <div class="search-result-item">
			<p class="search-result-address">${addr}${note}</p>
			<p class="search-result-date">${o.date}</p>
		  </div>`;
	  });

	  box.innerHTML = html;
	  addHeatmap(found);
	  const lats = found.map(o => o.lat), lons = found.map(o => o.lon);
	  map.setBounds(
		[[Math.min(...lats), Math.min(...lons)], [Math.max(...lats), Math.max(...lons)]],
		{ checkZoomRange: true }
	  );
	}
  </script>

  <style>
	@keyframes spin {
	  to { transform: rotate(360deg); }
	}
  </style>
</body>
</html>
